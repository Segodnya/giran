---
import Layout from '../../layouts/Layout.astro';
import { fetchArticleById, formatArticleTitle } from '../../services/api';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

let article;
let error;

try {
  article = await fetchArticleById(id);
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error occurred';
}

// Check if this is an HTMX request
const isHtmxRequest = Astro.request.headers.get('hx-request') === 'true';

// If it's an HTMX request, return only the article content
if (isHtmxRequest) {
  if (error) {
    return new Response(
      `
      <div class="alert alert-error">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Error loading article: ${error}</span>
        </div>
        <div class="flex-none">
          <button class="btn btn-sm btn-ghost" onclick="document.getElementById('article-content').classList.add('hidden')">‚úï</button>
        </div>
      </div>
    `,
      {
        headers: { 'Content-Type': 'text/html' },
      },
    );
  }

  if (!article) {
    return new Response(
      `
      <div class="alert alert-warning">
        <span>Article not found</span>
      </div>
    `,
      {
        headers: { 'Content-Type': 'text/html' },
      },
    );
  }

  return new Response(
    `
    <article class="prose prose-lg max-w-none">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-4xl font-bold mb-2">${formatArticleTitle(article.name)}</h1>
          <div class="flex gap-2 text-sm text-[var(--bc)] opacity-70">
            <span class="badge badge-outline">${Math.round(article.size / 1024)} KB</span>
            <span class="badge badge-outline">Markdown</span>
          </div>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="document.getElementById('article-content').classList.add('hidden')">
          ‚úï Close
        </button>
      </div>
      
      <div class="divider"></div>
      
      <div class="markdown-content">
        ${article.html}
      </div>
    </article>
    <script>
      // Re-highlight code blocks after HTMX content is loaded
      if (typeof window !== 'undefined' && window.hljs) {
        window.hljs.highlightAll();
      }
    </script>
  `,
    {
      headers: { 'Content-Type': 'text/html' },
    },
  );
}

// For non-HTMX requests, return the full page
if (error || !article) {
  return Astro.redirect(
    '/?error=' + encodeURIComponent(error || 'Article not found'),
  );
}
---

<Layout
  title={formatArticleTitle(article.name)}
  description={`Read article: ${formatArticleTitle(article.name)}`}
>
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <a href="/" class="btn btn-ghost btn-sm"> ‚Üê Back to Articles </a>
    </div>

    <article class="prose prose-lg max-w-none">
      <header class="mb-8">
        <h1 class="text-4xl font-bold mb-4">
          {formatArticleTitle(article.name)}
        </h1>
        <div class="flex gap-2 text-sm text-[var(--bc)] opacity-70">
          <span class="badge badge-outline"
            >{Math.round(article.size / 1024)} KB</span
          >
          <span class="badge badge-outline">Markdown</span>
        </div>
      </header>

      <div class="divider"></div>

      <div class="markdown-content" set:html={article.html} />
    </article>
  </div>
</Layout>

<style>
  @reference "../../styles/global.css";
  /* Enhanced styles for markdown content with syntax highlighting */
  .markdown-content {
    color: var(--bc);
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    color: var(--bc);
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .markdown-content h1 {
    font-size: 1.875rem;
  }
  .markdown-content h2 {
    font-size: 1.5rem;
  }
  .markdown-content h3 {
    font-size: 1.25rem;
  }
  .markdown-content h4 {
    font-size: 1.125rem;
  }

  .markdown-content p {
    margin-bottom: 1rem;
    line-height: 1.625;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin-bottom: 1rem;
    margin-left: 1.5rem;
  }

  .markdown-content li {
    margin-bottom: 0.5rem;
  }

  .markdown-content blockquote {
    border-left: 4px solid;
    border-left-color: var(--p);
    padding-left: 1rem;
    padding: 1rem;
    border-radius: 0 0.5rem 0.5rem 0;
    margin: 1rem 0;
    background-color: var(--b2);
    font-style: italic;
  }

  /* Enhanced code block styling with syntax highlighting support */
  .markdown-content pre {
    background-color: #111827;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1rem;
    position: relative;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .markdown-content pre code {
    background-color: transparent;
    padding: 0;
    color: #f3f4f6;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .markdown-content code {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: monospace;
    background-color: var(--b3);
    color: #e11d48;
  }

  .markdown-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  /* Copy button for code blocks */
  .markdown-content pre:hover::before {
    content: 'üìã Copy';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: #1f2937;
    color: #d1d5db;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .markdown-content a {
    color: var(--p);
    text-decoration: underline;
  }
  .markdown-content a:hover {
    text-decoration: none;
  }

  .markdown-content table {
    width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
    background-color: var(--b1);
  }

  .markdown-content thead {
    background-color: var(--b2);
  }
  .markdown-content tbody tr:nth-child(even) {
    background-color: var(--b2);
  }

  .markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    margin: 1rem 0;
  }

  /* Enhanced syntax highlighting overrides for better theme integration */
  .markdown-content .hljs {
    background-color: #111827;
    color: #f3f4f6;
  }

  .markdown-content .hljs-comment,
  .markdown-content .hljs-quote {
    color: #6b7280;
    font-style: italic;
  }

  .markdown-content .hljs-keyword,
  .markdown-content .hljs-selector-tag,
  .markdown-content .hljs-literal {
    color: #60a5fa;
  }

  .markdown-content .hljs-string,
  .markdown-content .hljs-doctag {
    color: #4ade80;
  }

  .markdown-content .hljs-number,
  .markdown-content .hljs-regexp,
  .markdown-content .hljs-link {
    color: #f87171;
  }

  .markdown-content .hljs-function .hljs-title,
  .markdown-content .hljs-params {
    color: #fbbf24;
  }

  .markdown-content .hljs-built_in,
  .markdown-content .hljs-class .hljs-title {
    color: #a78bfa;
  }

  .markdown-content .hljs-attr,
  .markdown-content .hljs-variable,
  .markdown-content .hljs-template-variable {
    color: #22d3ee;
  }

  .markdown-content .hljs-operator,
  .markdown-content .hljs-selector-attr,
  .markdown-content .hljs-selector-pseudo {
    color: #fb923c;
  }
</style>
